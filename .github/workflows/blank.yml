name: Build Pixel 16 M34 (Auto-Overlay)
on:
  workflow_dispatch:
    inputs:
      gsi_url:
        description: 'Pixel 16 GSI URL'
        required: true
        default: 'https://sourceforge.net/projects/mystic-gsi-updates/files/Pixel/Pixel-cheetah-16-14089870-AB-20251002-MysticGSI.zip/download'

jobs:
  build_pixel:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Setup Tools
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo apt-get clean
          sudo apt-get update
          sudo apt-get install -y git zip unzip android-sdk-libsparse-utils
          wget https://raw.githubusercontent.com/xpirt/sdat2img/master/sdat2img.py
          chmod +x sdat2img.py

      - name: 2. Download GSI
        run: |
          mkdir work
          cd work
          wget -O rom.zip "${{ inputs.gsi_url }}"
          unzip rom.zip
          mv $(find . -name "*.img" | head -n 1) system.img
          if file system.img | grep -q "sparse"; then
            simg2img system.img system_raw.img
            rm system.img
          else
            mv system.img system_raw.img
          fi

      - name: 3. Mount System
        run: |
          cd work
          mkdir -p mnt/system
          sudo mount -o loop,rw system_raw.img mnt/system

      - name: 4. Debloat (Minimal for Pixel)
        run: |
          # Pixel ROMs are already clean, but we remove some generic GSI junk
          S_DIR="work/mnt/system/system"
          sudo rm -rf $S_DIR/app/PhhTrebleApp
          sudo rm -rf $S_DIR/priv-app/Updater

      - name: 5. Inject Overlay (AUTO-DETECT)
        run: |
          git clone https://github.com/phoenixeditz1357-cmd/M34-Overlays overlay_repo
          OVERLAY_APK=$(find overlay_repo -name "*.apk" | head -n 1)
          
          if [ -f "$OVERLAY_APK" ]; then
             echo "Found: $OVERLAY_APK"
             TARGET="work/mnt/system/product/overlay"
             if [ ! -d "$TARGET" ]; then TARGET="work/mnt/system/system/product/overlay"; fi
             
             sudo mkdir -p "$TARGET"
             sudo cp "$OVERLAY_APK" "$TARGET/treble-overlay-samsung-m34x.apk"
             sudo chmod 644 "$TARGET/treble-overlay-samsung-m34x.apk"
             echo "Overlay Injected!"
          else
             echo "WARNING: No Overlay Found in Repo!"
          fi

      - name: 6. Customize Pixel Props
        run: |
          PROP="work/mnt/system/system/build.prop"
          
          # 1. Pixel Identity (Unlock Photos & Features)
          sudo sed -i 's/ro.product.model=.*/ro.product.model=Pixel 8 Pro/g' $PROP
          sudo sed -i 's/ro.product.brand=.*/ro.product.brand=google/g' $PROP
          sudo sed -i 's/ro.product.manufacturer=.*/ro.product.manufacturer=Google/g' $PROP
          sudo sed -i 's/ro.product.device=.*/ro.product.device=husky/g' $PROP
          
          # 2. Enable Pixel Features
          echo "ro.surface_flinger.max_frame_buffer_acquired_buffers=3" | sudo tee -a $PROP
          echo "persist.sys.pixelprops.photos=true" | sudo tee -a $PROP
          echo "persist.sys.pixelprops.games=true" | sudo tee -a $PROP
          
          # 3. M34 Stability (Exynos Fixes)
          echo "persist.dbg.ims_volte_enable=1" | sudo tee -a $PROP
          echo "persist.sys.phh.ims.volte=true" | sudo tee -a $PROP
          echo "persist.sys.fuse.passthrough.enable=true" | sudo tee -a $PROP

      - name: 7. Repack
        run: |
          cd work
          sudo umount mnt/system
          img2simg system_raw.img system_pixel_m34.img
          zip -0 -r Pixel_16_M34.zip system_pixel_m34.img

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: Pixel_16_M34
          path: work/Pixel_16_M34.zip
